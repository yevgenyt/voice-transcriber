# Voice Transcriber - Session Handoff

**Date**: January 22, 2026
**Status**: Fully functional - significantly faster with Vulkan GPU
**Location**: `/home/yev/Applications/voice-transcriber`

## Current Situation

Voice transcriber is fully operational with major speed improvements. Now uses whisper.cpp with Vulkan GPU acceleration on AMD Radeon 890M, achieving ~7x realtime transcription speed.

## Work Completed This Session

### Whisper.cpp Integration (Major Speed Improvement)
- Added whisper.cpp backend with Vulkan GPU acceleration
- AMD Radeon 890M now handles transcription (~7x realtime)
- Configurable backend: `WHISPER_BACKEND = "whisper-cpp"` or `"faster-whisper"`
- whisper.cpp location: `~/Applications/whisper.cpp/`

### Transcription Optimizations
- `beam_size=1` (greedy decoding - faster)
- `vad_filter=True` (skip silence)
- `without_timestamps=True` (don't compute timestamps)
- Changed model to `distil-small.en` for faster-whisper fallback

### Keyboard Detection Fix
- Fixed device selection picking mouse (MX Master 2S) instead of keyboard (WK75 BT1)
- Now skips devices with "mouse" in name
- Prefers devices with "keyboard" in name
- Extracted `_get_keyboard_candidates()` for reuse

### Stuck Modifier Keys Fix
- Added `_release_stuck_modifiers()` using evdev UInput
- Releases Shift/Ctrl/Alt after keyboard reconnection
- Note: Caps Lock is hardware state on keyboard - not affected

### Code Quality (via code-critic-reviewer agent)
- Removed dead code in `_save_config()`
- Fixed resource leaks - InputDevice objects now closed after inspection
- Added proper UInput capabilities definition
- Added timeout warning when recording thread doesn't stop cleanly

## Key Files

| File | Purpose |
|------|---------|
| `transcriber.py` | Main application with all features |
| `transcriber_config.json` | User settings (microphone_gain) - auto-managed |
| `requirements.txt` | Python dependencies |
| `README.md` | Full documentation |
| `~/Applications/whisper.cpp/` | whisper.cpp installation (Vulkan GPU) |

## System Requirements

```bash
# Required for text input on Wayland/GNOME
sudo apt install ydotool
sudo chmod 0666 /dev/uinput  # Or add user to uinput group

# whisper.cpp with Vulkan (already installed)
# Location: ~/Applications/whisper.cpp/
# Model: ~/Applications/whisper.cpp/models/ggml-small.en.bin
```

## Configuration

Config stored in `transcriber_config.json`:
```json
{
  "microphone_gain": 0.88
}
```

Key constants in `transcriber.py`:
```python
WHISPER_BACKEND = "whisper-cpp"      # or "faster-whisper"
WHISPER_CPP_PATH = "~/Applications/whisper.cpp/build/bin/whisper-cli"
WHISPER_CPP_MODEL = "~/Applications/whisper.cpp/models/ggml-small.en.bin"
MAX_RECORDING_DURATION = 300         # 5 minutes safety limit
```

## Recent Commits

```
6d3b698 - Add whisper.cpp backend with Vulkan GPU acceleration
d3ed06f - Address code review findings: fix leaks, dead code, UInput
a159bb4 - Fix keyboard detection to prefer actual keyboards over mice
```

## Available Agents for Delegation

- **code-critic-reviewer**: Run after implementing new features to identify code quality issues
- **Explore**: For searching codebase and understanding code structure
- **Plan**: For designing implementation strategies
- **docs-librarian**: For organizing documentation

## To Resume

1. **Start transcriber**: `transcriber` (or `python3 transcriber.py` in venv)
2. **Test transcription speed**: Should be nearly instant with Vulkan GPU
3. **If mic unavailable**: Check `fuser -v /dev/snd/*` and restart PipeWire if needed
4. **Switch backend**: Change `WHISPER_BACKEND` in transcriber.py

## Known Working State

- **GPU**: AMD Radeon 890M (Vulkan) - ~7x realtime transcription
- **Keyboard**: WK75 BT1 Keyboard (Bluetooth)
- **Mouse**: Logitech MX Master 2S (properly excluded from keyboard detection)
- **Microphone**: Jieli Technology USB Composite Device (card 2)
- **Hotkey**: Left Shift + Left Ctrl + Space
- **Text input**: ydotool type (works in all apps)
- **Backend**: whisper.cpp with Vulkan GPU acceleration

## Known Limitations

- **Microphone battery**: Jieli USB mic doesn't expose battery level
- **Caps Lock**: Hardware toggle state preserved after keyboard reconnect
- **Mic held by other apps**: If Chromium etc. holds mic, restart PipeWire: `systemctl --user restart pipewire pipewire-pulse`

---

**Last verified**: January 22, 2026 - All features working, whisper.cpp Vulkan GPU tested and fast
